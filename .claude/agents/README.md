# 仕様変更支援エージェント

C#/.NETプロジェクトの仕様変更を支援するClaude Codeエージェントのセットです。

## 📋 目次

- [概要](#概要)
- [エージェント構成](#エージェント構成)
- [セットアップ](#セットアップ)
- [クイックスタート](#クイックスタート)
- [ワークフロー](#ワークフロー)
- [成果物](#成果物)
- [ファイル構成](#ファイル構成)
- [使用例](#使用例)
- [トラブルシューティング](#トラブルシューティング)
- [ライセンス](#ライセンス)

---

## 概要

このエージェントセットは、C#/.NETプロジェクトの仕様変更を以下の流れで支援します：

1. **影響範囲の分析** - 変更による影響を包括的に分析
2. **実装計画の策定** - 優先順位とリスクを考慮した計画
3. **変更仕様書の生成** - HTML形式の詳細な仕様書
4. **フローチャートの生成** - draw.io形式の視覚的なフロー図
5. **ソースコード変更** - 実装の実行
6. **テスト仕様書の作成** - 包括的なテストケース

### 特徴

- ✅ **体系的な分析**: 直接影響・間接影響を2レベルで分析
- ✅ **リスク評価**: 高/中/低の3段階でリスクを評価
- ✅ **後方互換性重視**: 既存機能への影響を最小化
- ✅ **視覚的な仕様書**: 修正前/修正後を対比したHTML仕様書
- ✅ **フローチャート自動生成**: draw.io形式で編集可能
- ✅ **承認ポイント**: 各段階で確認・承認可能
- ✅ **TodoList連携**: 進捗をリアルタイムで管理

---

## エージェント構成

### 1. spec-analyzer

**役割**: 仕様変更の影響範囲を分析

**機能**:
- 変更要求の理解（What/Why/Where/How）
- 直接影響・間接影響の特定
- 依存関係の分析（内部/外部）
- リスク評価（高/中/低）
- 破壊的変更の検出と緩和策の提案
- テストカバレッジの評価
- 工数見積もり（small/medium/large）

**出力**:
- `analysis-result.json` - 構造化された分析結果
- `analysis-summary.md` - 人間が読みやすいサマリー

**詳細**: [spec-analyzer.md](./spec-analyzer.md)

---

### 2. spec-doc-generator

**役割**: 変更仕様書とフローチャートを生成

**機能**:
- 詳細な変更仕様書（HTML）の生成
- フローチャート（draw.io）の生成
- テスト仕様書の生成
- 修正前/修正後の対比表示
- 変更箇所の黄色ハイライト
- 補足事項の各項目への配置

**出力**:
- `SPEC_CHANGES.html` - 変更仕様書
- `flowchart_No{番号}.drawio` - フローチャート
- `TEST_SPEC.html` - テスト仕様書

**詳細**: [spec-doc-generator.md](./spec-doc-generator.md)

---

## セットアップ

### 前提条件

- Claude Code CLI がインストールされていること
- C#/.NET プロジェクトが存在すること
- Git リポジトリ（推奨）

### インストール

1. このフォルダ（`.claude/agents`）をプロジェクトの `.claude/agents` にコピー：

```bash
# 新規プロジェクトの場合
mkdir -p your-project/.claude/agents
cp -r .claude/agents/* your-project/.claude/agents/

# 既存プロジェクトの場合
cp -r .claude/agents/* /path/to/your-project/.claude/agents/
```

2. エージェントが正しく配置されているか確認：

```bash
ls -la your-project/.claude/agents/
# 以下が表示されるはず:
# spec-analyzer.md
# spec-doc-generator.md
# spec-change-workflow-guide.md
# README.md (このファイル)
# quick-start.md
# spec-doc-generator/ (サンプルファイル)
# examples/ (実行例)
```

3. Claude Code を起動：

```bash
cd your-project
claude
```

---

## クイックスタート

### 最短5分で始める

詳細は [quick-start.md](./quick-start.md) を参照してください。

**基本的な流れ**:

1. プロンプトテンプレートをコピー
2. 変更内容とファイルパスを記入
3. Claude Codeに貼り付けて実行
4. 各承認ポイントで確認・承認

**最小限のプロンプト例**:

```markdown
以下の仕様変更を実施してください。

## 変更要求
エラーメッセージに詳細情報を追加したい。

## ソースコードの場所
- プロジェクト: D:\MyProject\SRC\

## 実施手順
1. TodoList作成
2. spec-analyzerで分析 → 【承認ポイント1】
3. 実装計画作成 → 【承認ポイント2】
4. spec-doc-generatorで仕様書生成 → 【承認ポイント3】
5. ソースコード実装
6. テスト仕様書作成 → 【承認ポイント4】

各承認ポイントで必ず承認を待ってください。
```

---

## ワークフロー

### 標準ワークフロー

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 変更要求の提示                                           │
│    - 変更内容を明確に記述                                   │
│    - ソースコードの場所を指定                               │
│    - 期待する成果物を記載                                   │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. spec-analyzer による影響範囲分析                        │
│    - 直接影響・間接影響の特定                               │
│    - リスク評価                                             │
│    - 工数見積もり                                           │
│    → analysis-result.json, analysis-summary.md              │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 【承認ポイント1】分析結果の確認                            │
│    ✓ 影響範囲は適切か？                                    │
│    ✓ リスク評価は妥当か？                                  │
│    ✓ 見落としている影響はないか？                          │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 実装計画の策定                                           │
│    - 優先順位の決定                                         │
│    - タスクの分解                                           │
│    - リスク対策の明確化                                     │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 【承認ポイント2】実装計画の確認                            │
│    ✓ 計画は実現可能か？                                    │
│    ✓ 優先順位は適切か？                                    │
│    ✓ リスク対策は十分か？                                  │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. spec-doc-generator による仕様書生成                     │
│    - SPEC_CHANGES.html（変更仕様書）                       │
│    - flowchart_No{番号}.drawio（フローチャート）           │
│    - 修正前/修正後の対比                                    │
│    - 変更箇所の黄色ハイライト                               │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 【承認ポイント3】変更仕様書の確認                          │
│    ✓ 仕様は正確か？                                        │
│    ✓ 抜け漏れはないか？                                    │
│    ✓ フローチャートは正しいか？                            │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. ソースコード変更の実装                                   │
│    - 承認された仕様に基づいて実装                           │
│    - 優先度の高い項目から実装                               │
│    - 後方互換性の維持                                       │
│    - エラーハンドリング                                     │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. テスト仕様書の作成                                       │
│    - 単体テスト                                             │
│    - 統合テスト                                             │
│    - 実機テスト（手動テスト手順）                           │
│    → TEST_SPEC.html                                         │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 【承認ポイント4】テスト仕様書の確認                        │
│    ✓ テストカバレッジは十分か？                            │
│    ✓ 異常系テストは含まれているか？                        │
│    ✓ 後方互換性テストはあるか？                            │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ 7. 完了報告                                                 │
│    - 全成果物の確認                                         │
│    - TodoListの全項目完了確認                               │
│    - 変更内容のサマリー                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 成果物

### 1. 分析結果

**analysis-result.json**
```json
{
  "timestamp": "2026-01-08T10:00:00Z",
  "change_request": "変更要求の説明",
  "affected_components": [...],
  "dependencies": {...},
  "breaking_changes": [...],
  "test_coverage": {...},
  "recommendations": [...],
  "estimated_effort": "medium"
}
```

**analysis-summary.md**
- エグゼクティブサマリー
- 変更の範囲
- リスク評価
- 推奨事項
- 次のステップ

### 2. 変更仕様書

**SPEC_CHANGES.html**
- 変更点管理番号
- ソース・ファイル名
- モジュール名
- フローチャートへのリンク
- 修正内容（背景・目的、変更概要）
- 修正前/修正後の対比表
- 補足事項（後方互換性、制約事項、注意事項、計算ロジック）

**flowchart_No{番号}.drawio**
- 修正前と修正後の対比フロー
- 変更箇所の黄色ハイライト
- 画面処理（緑色）、システム処理（青色）

### 3. テスト仕様書

**TEST_SPEC.html**
- 単体テスト
- 統合テスト
- 実機テスト（手動テスト手順）
- 正常系・異常系・境界値テスト
- 後方互換性テスト

---

## ファイル構成

```
.claude/
  agents/
    ├── README.md                          # このファイル
    ├── quick-start.md                     # クイックスタートガイド
    ├── spec-change-workflow-guide.md      # 詳細なワークフローガイド
    │
    ├── spec-analyzer.md                   # 影響範囲分析エージェント定義
    ├── spec-doc-generator.md              # 仕様書生成エージェント定義
    │
    ├── spec-doc-generator/                # サポートファイル
    │   ├── SPEC_CHANGES.html              # 変更仕様書のサンプル
    │   └── 変更仕様書サンプル.pdf         # PDFサンプル
    │
    └── examples/                          # 実行例
        ├── example-01-simple-change/      # シンプルな変更例
        │   ├── prompt.md                  # 使用したプロンプト
        │   ├── analysis-result.json       # 分析結果
        │   └── SPEC_CHANGES.html          # 生成された仕様書
        │
        └── example-02-complex-change/     # 複雑な変更例
            ├── prompt.md
            ├── analysis-result.json
            ├── SPEC_CHANGES.html
            └── flowchart_No001.drawio
```

---

## 使用例

### 例1: シンプルなUI変更

```markdown
以下の仕様変更を実施してください。

## 変更要求
エラーダイアログのメッセージに、エラーコードを追加表示したい。

## ソースコードの場所
- プロジェクト: D:\MyProject\SRC\
- エラーダイアログ: D:\MyProject\SRC\ErrorDialog.cs

## 実施手順
[標準ワークフローに従う]
```

詳細: [examples/example-01-simple-change/](./examples/example-01-simple-change/)

### 例2: 複雑な機能追加

```markdown
以下の仕様変更を実施してください。

## 変更要求
ダウンロード進捗ダイアログに、残り時間のリアルタイム更新機能を追加。
car完了ごとに実測時間から残り時間を再計算して表示する。

## ソースコードの場所
- プロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 進捗ダイアログ: dlgDLProgress.cs
- ダウンロード処理: frmLogDataDownload.cs

## 実施手順
[標準ワークフローに従う]
```

詳細: [examples/example-02-complex-change/](./examples/example-02-complex-change/)

---

## トラブルシューティング

### Q1: 承認ポイントで止まらない

**A**: プロンプトに以下を追加してください：

```markdown
**重要**: 各承認ポイントで必ず作業を停止し、「承認待ち」と表示してください。
私が「承認します」と返答するまで、次のステップに進まないでください。
```

### Q2: TodoListが更新されない

**A**: プロンプトに以下を追加してください：

```markdown
**TodoList管理**:
- 作業開始時に全タスクをTodoListに追加
- 各タスク開始時に in_progress に更新
- 各タスク完了時に completed に更新
```

### Q3: 分析が浅い・詳細すぎる

**A**: 分析の深さを指定してください：

```markdown
## 分析要件
- 分析レベル: 詳細（または 標準、簡易）
- 重点項目: セキュリティ、パフォーマンス、後方互換性
```

### Q4: 仕様書の形式を変更したい

**A**: spec-doc-generator.md を編集して、HTMLテンプレートをカスタマイズできます。

### Q5: エージェントが見つからない

**A**: エージェントファイルが正しい場所にあるか確認：

```bash
ls -la .claude/agents/spec-*.md
```

なければ、`.claude/agents/` フォルダを作成してファイルを配置してください。

---

## 高度な使い方

### カスタムエージェントの作成

既存のエージェントをベースに、プロジェクト固有のエージェントを作成できます：

1. `spec-analyzer.md` をコピー
2. プロジェクト固有のルールを追加
3. `.claude/agents/my-custom-analyzer.md` として保存

### 複数プロジェクトでの利用

共通の `.claude/agents/` フォルダを作成し、シンボリックリンクで各プロジェクトから参照：

```bash
# 共通フォルダ
mkdir -p ~/claude-agents/spec-change/

# プロジェクトからリンク
ln -s ~/claude-agents/spec-change/ project-a/.claude/agents
ln -s ~/claude-agents/spec-change/ project-b/.claude/agents
```

---

## ベストプラクティス

### 1. 変更要求は明確に

❌ 悪い例:
```
ダウンロードを改善したい
```

✅ 良い例:
```
ダウンロード進捗ダイアログに以下の機能を追加：
1. 残り時間のリアルタイム更新
2. car完了ごとの時間再計算
3. 1分ごとのカウントダウン
```

### 2. ソースの場所は具体的に

❌ 悪い例:
```
SRCフォルダ内
```

✅ 良い例:
```
- プロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 対象ファイル: dlgDLProgress.cs, frmLogDataDownload.cs
```

### 3. 承認ポイントを活用

各承認ポイントで以下を確認：
- ✓ 想定通りの分析・計画か？
- ✓ 見落としている影響はないか？
- ✓ リスク対策は十分か？

### 4. TodoListで進捗確認

定期的に `/tasks` コマンドで進捗を確認してください。

---

## FAQ

**Q: Windows以外でも使えますか？**
A: はい。ファイルパスをOSに合わせて変更してください（Windows: `D:\...`, Linux/Mac: `/home/...`）

**Q: C#以外の言語でも使えますか？**
A: 基本的な考え方は同じですが、spec-analyzerの分析ルールをその言語に合わせてカスタマイズする必要があります。

**Q: 生成された仕様書を編集できますか？**
A: はい。SPEC_CHANGES.htmlは通常のHTMLファイルなので、テキストエディタやブラウザで編集できます。

**Q: フローチャートはどのツールで開けますか？**
A: draw.io Desktop、diagrams.net、またはオンラインのdraw.ioで開けます。

**Q: GitHubなどにコミットできますか？**
A: はい。`.claude/agents/` フォルダをリポジトリに含めることで、チームで共有できます。

---

## ライセンス

このエージェントセットは、あなたのプロジェクトで自由に使用・改変できます。

---

## サポート

質問や問題があれば、以下を確認してください：

1. [quick-start.md](./quick-start.md) - 基本的な使い方
2. [spec-change-workflow-guide.md](./spec-change-workflow-guide.md) - 詳細なワークフロー
3. [examples/](./examples/) - 実行例
4. [トラブルシューティング](#トラブルシューティング) - よくある問題

---

## 更新履歴

- **2026-01-08**: 初版作成
  - spec-analyzer エージェント追加
  - spec-doc-generator エージェント追加
  - ワークフローガイド追加
  - README、クイックスタート、サンプル追加

---

**Happy Coding with Claude! 🚀**
