# Example 02: 複雑な機能追加

このサンプルでは、ダウンロード進捗ダイアログに残り時間のリアルタイム更新機能を追加する、複雑な機能追加の例を示します。

## 使用したプロンプト

```markdown
以下の仕様変更を実施してください。

## 変更要求

ダウンロード進捗ダイアログに、残り時間のリアルタイム更新機能を追加したい。

【詳細】
- 現在：ダウンロード開始時の予測時間が固定値で表示される
- 変更後：car完了ごとに実測時間から残り時間を再計算して表示
- 追加機能：1carのダウンロードに1分以上かかる場合、1分ごとにカウントダウン
- 設定：各記録種別（DATA_KIND）ごとに1car当たりの予測時間をINIファイルで設定可能

## ソースコードの場所

- メインプロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 進捗ダイアログ: D:\Home\MCR\R211\SRC\MDS_PTE\dlgDLProgress.cs
- ダウンロード処理: D:\Home\MCR\R211\SRC\MDS_PTE\frmLogDataDownload.cs
- 進捗情報クラス: D:\Home\MCR\R211\SRC\MDS_PTE\ProgressInfo.cs
- 設定ファイル（開発版）: D:\Home\MCR\R211\SRC\MDS_PTE\MDS_PTE.ini
- 設定ファイル（パッケージ版）: D:\Home\MCR\R211\SRC\SetupPkg\MDS_PTE.ini

## 出力ファイルの保存場所

- 分析結果: D:\Home\MCR\R211\Output\Analysis\
- 変更仕様書: D:\Home\MCR\R211\Output\Specs\
- テスト仕様書: D:\Home\MCR\R211\Output\Tests\

## 実施手順

以下の手順で作業を進めてください。各承認ポイントで必ず私の承認を得てから次に進んでください。

### 1. 事前準備
- TodoListを作成し、全体の作業項目を管理
- 各タスクの完了時にTodoを更新

### 2. 影響範囲分析（spec-analyzer使用）
- spec-analyzerエージェントを起動
- コードベース全体への影響を分析
- 以下のファイルを生成：
  - analysis-result.json
  - analysis-summary.md
- **【承認ポイント1】** 分析結果を提示し、承認を待つ

### 3. 実装計画の作成
- 分析結果に基づいて詳細な実装計画を作成
- 優先順位、リスク、工数見積もりを含める
- **【承認ポイント2】** 実装計画を提示し、承認を待つ

### 4. 変更仕様書とフローチャート生成（spec-doc-generator使用）
- spec-doc-generatorエージェントを起動
- 分析結果（analysis-result.json）を参照
- 以下のファイルを生成：
  - SPEC_CHANGES.html（変更仕様書）
  - flowchart_No001.drawio（フローチャート）
- 以下のガイドラインに従うこと：
  - 事実ベースで記述し、抽象的表現を避ける
  - 修正前／修正後の2カラム構成
  - 変更箇所は黄色ハイライト
  - 補足事項は各変更点の直後に記載
  - 具体的な設定例、計算式、データ構造を記載
- **【承認ポイント3】** 変更仕様書とフローチャートを提示し、承認を待つ

### 5. ソースコード変更の実装
- 承認された仕様書に基づいて実装
- 優先度の高い項目から順に実装
- 後方互換性、エラーハンドリング、リソース管理に注意

### 6. テスト仕様書の作成
- 単体テスト、統合テスト、実機テストのテストケースを作成
- **【承認ポイント4】** テスト仕様書を提示し、承認を待つ

### 7. 完了報告
- 全ての成果物を確認
- 変更内容のサマリーを報告

## 注意事項

- 各承認ポイントで必ず作業を止め、私の指示を待ってください
- 不明点や懸念事項があれば、すぐに質問してください
- セキュリティ、パフォーマンス、後方互換性への影響は必ず評価してください

それでは、作業を開始してください。
```

## 生成された成果物

- `analysis-result.json` - 影響範囲分析結果
- `analysis-summary.md` - 分析サマリー（このディレクトリには含まれていません）
- `SPEC_CHANGES.html` - 変更仕様書（.claude/agents/spec-doc-generator/SPEC_CHANGES.htmlを参照）
- `flowchart_No001.drawio` - フローチャート（このディレクトリには含まれていません）

## 実行結果サマリー

### 影響範囲

**直接影響**:
- dlgDLProgress.cs（進捗ダイアログのUI更新ロジック）
- frmLogDataDownload.cs（car完了時の時間情報通知）
- ProgressInfo.cs（時間情報を含むデータ構造の追加）
- MDS_PTE.ini（新セクションの追加）

**間接影響**:
- タイマー処理の追加によるリソース管理
- イベントハンドラの登録・解放

### リスク評価

**全体リスク**: 高リスク

**高リスク領域**:
- UIとバックエンド処理の同期（タイマーとcar完了イベント）
- リソースリーク（タイマーとイベントハンドラの適切な解放）
- 既存のダウンロード処理への影響

**中リスク領域**:
- INI設定値の妥当性検証
- 数値オーバーフロー対策

**低リスク領域**:
- 設定ファイルの追加（既存設定は維持）

### 工数見積もり

**合計**: medium（1-2週間）

- 設計: 2日
- 実装: 5日
- テスト: 3日
- デプロイ準備: 1日

### 実装内容

1. **MDS_PTE.ini**
   - [EstimatedDownloadTime]セクションを追加
   - 各DATA_KINDごとに1car当たりの予測時間を定義

2. **ProgressInfo.cs**
   - CarDownloadTimeInfoクラスを追加
   - car完了時の時間情報を保持

3. **frmLogDataDownload.cs**
   - car完了時に時間情報を記録
   - ProgressInfoに時間情報を設定して通知

4. **dlgDLProgress.cs**
   - 残り時間の計算ロジックを実装
   - 1分ごとのカウントダウンタイマーを追加
   - リソース解放処理を追加

### テストケース

**単体テスト**: 8件
- INI設定読み込みの確認
- 残り時間計算ロジックの確認
- タイマー動作の確認
- リソース解放の確認

**統合テスト**: 5件
- car完了イベントと残り時間更新の連携
- タイマーとUI更新の同期
- キャンセル時の動作確認

**実機テスト**: 3件
- 実際のダウンロードでの残り時間表示
- 長時間ダウンロード時のカウントダウン
- 異常終了時のリソース解放

## 学習ポイント

### 1. 複雑な機能のプロンプト書き方

✅ **良い点**:
- 変更要求が具体的（現在の動作、変更後の動作、追加機能を明記）
- ソースの場所が詳細（複数ファイル、設定ファイルも含む）
- ガイドラインが明示されている

### 2. 高リスク変更の扱い

このような高リスク変更では：
- **承認ポイントを厳守**: 各段階で確認・承認
- **段階的実装**: 優先度の高い項目から実装
- **十分なテスト**: 単体、統合、実機テストを全て実施

### 3. リソース管理の重要性

タイマーやイベントハンドラを使用する場合：
- 必ず解放処理を実装
- 異常終了時も考慮
- メモリリークの防止

### 4. 後方互換性の維持

既存機能への影響を最小化：
- INIセクションが存在しない場合のフォールバック
- CarTimeInfo情報が提供されない場合の対応
- 既存のSTATUS_TEXT_OK検出処理も維持

## 応用例

このサンプルをベースに、以下のような変更にも対応できます：

1. **プログレスバーの追加**
   - 残り時間と同様に、プログレスバーもリアルタイム更新

2. **ダウンロード速度の表示**
   - 実測時間から平均速度を計算して表示

3. **一時停止・再開機能**
   - ダウンロードの一時停止・再開に対応

4. **履歴機能**
   - 過去のダウンロード時間を記録し、次回の予測精度を向上

## Simple Change との比較

| 項目 | Example 01 (Simple) | Example 02 (Complex) |
|------|---------------------|----------------------|
| 影響範囲 | 3ファイル | 5ファイル（設定ファイル含む） |
| リスク | 中リスク | 高リスク |
| 工数 | small (1-3日) | medium (1-2週間) |
| UI/Backend | UIのみ | UI + Backend + タイマー |
| リソース管理 | 不要 | 必須（タイマー、イベント） |
| 後方互換性 | オーバーロード追加 | 複数のフォールバック処理 |
| テストケース | 10件 | 16件 |

## 次のステップ

さらに複雑な変更については：
- 複数のエージェントを連携させる方法を検討
- カスタムエージェントの作成を検討
- CI/CDパイプラインへの組み込みを検討
