# Example 02: 複雑な機能追加

このサンプルでは、ダウンロード進捗ダイアログに残り時間のリアルタイム更新機能を追加する、複雑な機能追加の例を示します。

## プロンプト作成のヒント

### 1. INPUT資料の準備

**推奨：Markdown形式に変換**
- 元仕様書、設計書などをMarkdown（.md）に変換
- **項番を必ず付ける**（例: 1.1, 1.2, 2.1）
- トークン消費が少なく、検索・参照が容易
- エージェントが必要な箇所を素早く見つけられる

**PDFのまま使用する場合（限定的）**
- **図表が重要な場合のみ**
- **5ページ程度まで**に限定
- ページ番号を明記して参照箇所を指定
- トークン消費が多いため、大規模なPDFは避ける

**変換例：元仕様書のMarkdown化**
```markdown
# システム仕様書 v1.0

## 1. システム概要
### 1.1 編成仕様
- 対応編成: 3両固定
- 最大car数: 3
- データ収集単位: 1car

## 2. データ構造
### 2.1 ProgressInfo
- Total: 総car数（固定値3）
- Current: 現在処理中のcar番号（1-3）

## 3. INI設定
### 3.1 [Timer]セクション
- DownloadTimeout=180000（3car × 60秒）
```

### 2. 変更仕様の整理（強く推奨）

**Claude Web Chatで事前整理することを強く推奨します**

大きな変更や複雑な要件の場合、いきなりプロンプトを書くのではなく、まずClaude Web Chat（https://claude.ai）で対話的に整理すると効果的です。

**実際の手順：**

1. **Claude Web Chatを開く**
   - https://claude.ai にアクセス

2. **元仕様書や変更要求の概要を貼り付ける**
   ```
   【あなた】
   以下の元仕様書を読んで、列車の編成を3両から6両に変更する場合の
   変更要求を整理してください。

   （元仕様書のMarkdownを貼り付け）

   変更したいこと：
   - 3両固定 → 6両可変（1-6両）
   - 編成数をINIファイルで設定可能に
   - UIに編成選択機能を追加
   ```

3. **Claudeと対話しながら変更仕様を整理**
   ```
   【Claude】
   以下のように整理できます：

   【現状】
   - 対応編成: 3両固定
   - データ構造: Total=3（固定値）
   - UI: 編成選択なし
   - INI設定: 編成数の設定項目なし

   【変更後】
   - 対応編成: 1-6両（可変）
   - データ構造: Total=1-6（可変値）
   - UI: 編成選択ドロップダウン追加
   - INI設定: MaxCars設定を追加

   【影響範囲】
   1. データ構造の変更
      - ProgressInfo.Total を固定値→可変値に
      - CarDownloadInfo の配列サイズを6まで拡張

   2. UI変更
      - frmLogDataDownload に編成選択コンボボックス追加
      - dlgDLProgress の進捗表示を6両分まで対応

   3. INI設定追加
      - [System]セクションに MaxCars=6 を追加

   【懸念事項】
   - 既存の3両データとの互換性
   - 6両分のメモリ確保
   - タイムアウト設定の調整
   ```

4. **整理された内容をコピーして、プロンプトの【詳細】に貼り付ける**
   - Claude Web Chatで整理された内容を、そのままコピー
   - このプロンプトテンプレートの【詳細】セクションに貼り付け
   - 必要に応じて微調整

**Web Chatでの対話例：**
```
【あなた】
データ構造の変更について、もう少し詳しく教えてください。

【Claude】
データ構造の変更詳細：

1. ProgressInfo クラス
   - 現行：
     public int Total = 3;  // 固定値

   - 変更後：
     public int Total { get; set; }  // 可変値（1-6）
     // INIファイルから読み込んだMaxCarsを設定

2. CarDownloadInfo 配列
   - 現行：
     CarDownloadInfo[] carInfos = new CarDownloadInfo[3];

   - 変更後：
     CarDownloadInfo[] carInfos = new CarDownloadInfo[MaxCars];
     // MaxCarsはINIから読み込み（最大6）

この変更により、後方互換性のため、INIにMaxCarsが設定されていない場合は
デフォルト値3を使用するフォールバック処理が必要です。
```

### 3. プロンプトの品質向上

**事前整理により得られる効果：**
- ✅ **変更要求が明確になる**：曖昧さがなくなる
- ✅ **影響範囲の見落としが減る**：対話で洗い出せる
- ✅ **spec-analyzerの分析精度が上がる**：明確な要求で正確な分析
- ✅ **spec-doc-generatorの生成品質が上がる**：詳細な情報で高品質な仕様書
- ✅ **手戻りが減る**：実装前に要件が固まる

**整理すべき項目：**
1. 現状と変更後の対比
2. 影響範囲の洗い出し
3. データ構造の変更点
4. UI変更点
5. 設定ファイルの変更点
6. 懸念事項・リスク
7. 後方互換性の方針

### 4. 実践的なワークフロー

```
1. Claude Web Chatで変更要求を整理（30分-1時間）
   ↓
2. 整理された内容をプロンプトに反映
   ↓
3. Claude Codeで spec-analyzer を実行
   ↓
4. 分析結果を確認・承認
   ↓
5. spec-doc-generator で仕様書生成
   ↓
6. 実装
```

**時間配分の目安：**
- Web Chatでの整理: 30分-1時間
- プロンプト作成: 10-15分
- 実際の実行: 20-30分（承認待ち除く）

**合計: 1-2時間**（整理なしで進めて手戻りするより効率的）

---

## 使用したプロンプト

```markdown
以下の仕様変更を実施してください。

## 変更要求

ダウンロード進捗ダイアログに、残り時間のリアルタイム更新機能を追加したい。

【詳細】
- 現在：ダウンロード開始時の予測時間が固定値で表示される
- 変更後：car完了ごとに実測時間から残り時間を再計算して表示
- 追加機能：1carのダウンロードに1分以上かかる場合、1分ごとにカウントダウン
- 設定：各記録種別（DATA_KIND）ごとに1car当たりの予測時間をINIファイルで設定可能

## ソースコードの場所

- メインプロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 進捗ダイアログ: D:\Home\MCR\R211\SRC\MDS_PTE\dlgDLProgress.cs
- ダウンロード処理: D:\Home\MCR\R211\SRC\MDS_PTE\frmLogDataDownload.cs
- 進捗情報クラス: D:\Home\MCR\R211\SRC\MDS_PTE\ProgressInfo.cs
- 設定ファイル（開発版）: D:\Home\MCR\R211\SRC\MDS_PTE\MDS_PTE.ini
- 設定ファイル（パッケージ版）: D:\Home\MCR\R211\SRC\SetupPkg\MDS_PTE.ini

## 出力ファイルの保存場所

- 分析結果: D:\Home\MCR\R211\Output\Analysis\
- 変更仕様書: D:\Home\MCR\R211\Output\Specs\
- テスト仕様書: D:\Home\MCR\R211\Output\Tests\

## 実施手順

以下の手順で作業を進めてください。各承認ポイントで必ず私の承認を得てから次に進んでください。

### 1. 事前準備
- TodoListを作成し、全体の作業項目を管理
- 各タスクの完了時にTodoを更新

### 2. 影響範囲分析（spec-analyzer使用）
- spec-analyzerエージェントを起動
- コードベース全体への影響を分析
- 以下のファイルを生成：
  - analysis-result.json
  - analysis-summary.md
- **【承認ポイント1】** 分析結果を提示し、承認を待つ

### 3. 実装計画の作成
- 分析結果に基づいて詳細な実装計画を作成
- 優先順位、リスク、工数見積もりを含める
- **【承認ポイント2】** 実装計画を提示し、承認を待つ

### 4. 変更仕様書とフローチャート生成（spec-doc-generator使用）
- spec-doc-generatorエージェントを起動
- 分析結果（analysis-result.json）を参照
- 以下のファイルを生成：
  - SPEC_CHANGES.html（変更仕様書）
  - flowchart_No001.drawio（フローチャート）
  - TEST_SPECIFICATION.html（テスト仕様書）
- 以下のガイドラインに従うこと：
  - **【重要】想定読者：ソフトウェア開発リーダークラス（設計レビュー担当者）**
  - **【重要】HTMLレイアウト：.claude/agents/spec-doc-generator/SPEC_CHANGES.html を厳守**
  - **設計視点での記述**：ソフトウェアとしての変更方針が見えるレベル
    - 実装詳細の逐次説明は避ける
    - コードの行番号やローカル変数の詳細は記載しない
  - **データ定義は具体的に記載**：クラス構造、プロパティ、INI設定項目
  - 事実ベースで記述し、抽象的・評価的表現を避ける
  - 修正前／修正後の2カラム構成
  - 変更箇所は<span class="highlight">でハイライト
  - 補足事項は各変更点の直後に記載
  - 具体的な設定例、計算式、データ構造を記載
- **【承認ポイント3】** 変更仕様書、フローチャート、テスト仕様書を提示し、承認を待つ

### 5. ソースコード変更の実装
- 承認された仕様書に基づいて実装
- 優先度の高い項目から順に実装
- 後方互換性、エラーハンドリング、リソース管理に注意
- **【承認ポイント4】** 実装完了後、変更内容を提示し、承認を待つ

### 6. 完了報告
- 全ての成果物を確認
- 変更内容のサマリーを報告
- 生成された成果物一覧：
  - analysis-result.json（分析結果）
  - SPEC_CHANGES.html（変更仕様書）
  - flowchart_No001.drawio（フローチャート）
  - TEST_SPECIFICATION.html（テスト仕様書）
  - 変更されたソースコード

## 注意事項

- 各承認ポイントで必ず作業を止め、私の指示を待ってください
- 不明点や懸念事項があれば、すぐに質問してください
- セキュリティ、パフォーマンス、後方互換性への影響は必ず評価してください

それでは、作業を開始してください。
```

## 生成された成果物

- `analysis-result.json` - 影響範囲分析結果
- `analysis-summary.md` - 分析サマリー
- `SPEC_CHANGES.html` - 変更仕様書（サンプル: .claude/agents/spec-doc-generator/SPEC_CHANGES.html）
- `flowchart_No001.drawio` - フローチャート
- `TEST_SPECIFICATION.html` - テスト仕様書（サンプル: .claude/agents/spec-doc-generator/TEST_SPECIFICATION.html）

## 実行結果サマリー

### 影響範囲

**直接影響**:
- dlgDLProgress.cs（進捗ダイアログのUI更新ロジック）
- frmLogDataDownload.cs（car完了時の時間情報通知）
- ProgressInfo.cs（時間情報を含むデータ構造の追加）
- MDS_PTE.ini（新セクションの追加）

**間接影響**:
- タイマー処理の追加によるリソース管理
- イベントハンドラの登録・解放

### リスク評価

**全体リスク**: 高リスク

**高リスク領域**:
- UIとバックエンド処理の同期（タイマーとcar完了イベント）
- リソースリーク（タイマーとイベントハンドラの適切な解放）
- 既存のダウンロード処理への影響

**中リスク領域**:
- INI設定値の妥当性検証
- 数値オーバーフロー対策

**低リスク領域**:
- 設定ファイルの追加（既存設定は維持）

### 工数見積もり

**合計**: medium（1-2週間）

- 設計: 2日
- 実装: 5日
- テスト: 3日
- デプロイ準備: 1日

### 実装内容

1. **MDS_PTE.ini**
   - [EstimatedDownloadTime]セクションを追加
   - 各DATA_KINDごとに1car当たりの予測時間を定義

2. **ProgressInfo.cs**
   - CarDownloadTimeInfoクラスを追加
   - car完了時の時間情報を保持

3. **frmLogDataDownload.cs**
   - car完了時に時間情報を記録
   - ProgressInfoに時間情報を設定して通知

4. **dlgDLProgress.cs**
   - 残り時間の計算ロジックを実装
   - 1分ごとのカウントダウンタイマーを追加
   - リソース解放処理を追加

### テストケース

**単体テスト**: 8件
- INI設定読み込みの確認
- 残り時間計算ロジックの確認
- タイマー動作の確認
- リソース解放の確認

**統合テスト**: 5件
- car完了イベントと残り時間更新の連携
- タイマーとUI更新の同期
- キャンセル時の動作確認

**実機テスト**: 3件
- 実際のダウンロードでの残り時間表示
- 長時間ダウンロード時のカウントダウン
- 異常終了時のリソース解放

## 学習ポイント

### 1. 複雑な機能のプロンプト書き方

✅ **良い点**:
- 変更要求が具体的（現在の動作、変更後の動作、追加機能を明記）
- ソースの場所が詳細（複数ファイル、設定ファイルも含む）
- ガイドラインが明示されている

### 2. 高リスク変更の扱い

このような高リスク変更では：
- **承認ポイントを厳守**: 各段階で確認・承認
- **段階的実装**: 優先度の高い項目から実装
- **十分なテスト**: 単体、統合、実機テストを全て実施

### 3. リソース管理の重要性

タイマーやイベントハンドラを使用する場合：
- 必ず解放処理を実装
- 異常終了時も考慮
- メモリリークの防止

### 4. 後方互換性の維持

既存機能への影響を最小化：
- INIセクションが存在しない場合のフォールバック
- CarTimeInfo情報が提供されない場合の対応
- 既存のSTATUS_TEXT_OK検出処理も維持

## 応用例

このサンプルをベースに、以下のような変更にも対応できます：

1. **プログレスバーの追加**
   - 残り時間と同様に、プログレスバーもリアルタイム更新

2. **ダウンロード速度の表示**
   - 実測時間から平均速度を計算して表示

3. **一時停止・再開機能**
   - ダウンロードの一時停止・再開に対応

4. **履歴機能**
   - 過去のダウンロード時間を記録し、次回の予測精度を向上

## Simple Change との比較

| 項目 | Example 01 (Simple) | Example 02 (Complex) |
|------|---------------------|----------------------|
| 影響範囲 | 3ファイル | 5ファイル（設定ファイル含む） |
| リスク | 中リスク | 高リスク |
| 工数 | small (1-3日) | medium (1-2週間) |
| UI/Backend | UIのみ | UI + Backend + タイマー |
| リソース管理 | 不要 | 必須（タイマー、イベント） |
| 後方互換性 | オーバーロード追加 | 複数のフォールバック処理 |
| テストケース | 10件 | 16件 |

## 次のステップ

さらに複雑な変更については：
- 複数のエージェントを連携させる方法を検討
- カスタムエージェントの作成を検討
- CI/CDパイプラインへの組み込みを検討
