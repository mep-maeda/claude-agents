# 仕様変更ワークフローガイド

このガイドでは、spec-analyzerとspec-doc-generatorを使った仕様変更の実施方法を説明します。

## ワークフロー概要

```
1. spec-analyzerで影響範囲分析
   ↓
2. 分析結果の確認・承認
   ↓
3. 実装計画の作成
   ↓
4. 計画の確認・承認
   ↓
5. spec-doc-generatorで変更仕様書とフローチャート生成
   ↓
6. 仕様書の確認・承認
   ↓
7. ソースコード変更の実装
   ↓
8. テスト仕様書の作成
   ↓
9. 完了
```

---

## 一括プロンプトテンプレート（承認ポイント付き）

以下のテンプレートをコピーして、具体的な内容を記入してClaude Codeに指示してください。

```markdown
以下の仕様変更を実施してください。

## 変更要求

【ここに変更内容を詳細に記述】

例：
ダウンロード進捗ダイアログに、残り時間のリアルタイム更新機能を追加したい。
現在は固定値だが、car完了ごとに実測時間から残り時間を再計算して表示する。
また、1carのダウンロードに1分以上かかる場合は、1分ごとに残り時間をカウントダウンする。

## ソースコードの場所

【プロジェクトとファイルのパスを記載】

例：
- メインプロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 進捗ダイアログ: D:\Home\MCR\R211\SRC\MDS_PTE\dlgDLProgress.cs
- ダウンロード処理: D:\Home\MCR\R211\SRC\MDS_PTE\frmLogDataDownload.cs
- 進捗情報クラス: D:\Home\MCR\R211\SRC\MDS_PTE\ProgressInfo.cs
- 設定ファイル: D:\Home\MCR\R211\SRC\MDS_PTE\MDS_PTE.ini

## 出力ファイルの保存場所

【生成されるドキュメントの保存先】

例：
- 分析結果: D:\Home\MCR\R211\Output\Analysis\
- 変更仕様書: D:\Home\MCR\R211\Output\Specs\
- テスト仕様書: D:\Home\MCR\R211\Output\Tests\

## 実施手順

以下の手順で作業を進めてください。各承認ポイントで必ず私の承認を得てから次に進んでください。

### 1. 事前準備
- TodoListを作成し、全体の作業項目を管理
- 各タスクの完了時にTodoを更新

### 2. 影響範囲分析（spec-analyzer使用）
- spec-analyzerエージェントを起動
- コードベース全体への影響を分析
- 以下のファイルを生成：
  - analysis-result.json
  - analysis-summary.md
- **【承認ポイント1】** 分析結果を提示し、承認を待つ

### 3. 実装計画の作成
- 分析結果に基づいて詳細な実装計画を作成
- 優先順位、リスク、工数見積もりを含める
- **【承認ポイント2】** 実装計画を提示し、承認を待つ

### 4. 変更仕様書とフローチャート生成（spec-doc-generator使用）
- spec-doc-generatorエージェントを起動
- 分析結果（analysis-result.json）を参照
- 以下のファイルを生成：
  - SPEC_CHANGES.html（変更仕様書）
  - flowchart_No{番号}.drawio（フローチャート）
- 以下のガイドラインに従うこと：
  - 事実ベースで記述し、抽象的表現を避ける
  - 修正前／修正後の2カラム構成
  - 変更箇所は黄色ハイライト
  - 補足事項は各変更点の直後に記載
  - 具体的な設定例、計算式、データ構造を記載
- **【承認ポイント3】** 変更仕様書とフローチャートを提示し、承認を待つ

### 5. ソースコード変更の実装
- 承認された仕様書に基づいて実装
- 優先度の高い項目から順に実装
- 各ファイルの変更完了時に：
  - 変更内容を説明
  - コンパイルエラーがないか確認
  - 簡単な動作確認（可能な場合）
- 以下の点に注意：
  - 後方互換性の維持
  - エラーハンドリング
  - リソース管理（タイマー、イベントハンドラの解放）
  - セキュリティ（インジェクション攻撃等への対策）

### 6. テスト仕様書の作成
- 変更仕様書に基づいたテスト項目を作成
- 以下のテストレベルを含める：
  - 単体テスト（ユニットテスト）
  - 統合テスト
  - 実機テスト（手動テスト手順）
- テストケースには以下を含める：
  - 正常系テスト
  - 異常系テスト
  - 境界値テスト
  - 後方互換性テスト
- **【承認ポイント4】** テスト仕様書を提示し、承認を待つ

### 7. 完了報告
- 全ての成果物を確認
- TodoListの全項目が完了していることを確認
- 変更内容のサマリーを報告

## 注意事項

- 各承認ポイントで必ず作業を止め、私の指示を待ってください
- 不明点や懸念事項があれば、すぐに質問してください
- 想定外のリスクや技術的課題が見つかった場合は、即座に報告してください
- セキュリティ、パフォーマンス、後方互換性への影響は必ず評価してください

それでは、作業を開始してください。
```

---

## プロンプトのカスタマイズ例

### 小規模な変更の場合

承認ポイントを減らすことができます：

```markdown
## 実施手順（簡易版）

### 1. 分析と計画
- spec-analyzerで影響範囲を分析
- 実装計画を作成
- **【承認ポイント1】** 分析結果と計画を提示し、承認を待つ

### 2. 仕様書作成と実装
- spec-doc-generatorで変更仕様書を生成
- ソースコード変更を実装
- テスト仕様書を作成
- **【承認ポイント2】** 全成果物を提示し、承認を待つ
```

### 分析のみ実施する場合

```markdown
## 実施手順（分析のみ）

### 1. 影響範囲分析
- spec-analyzerで影響範囲を分析
- リスク評価を含める
- **【完了】** 分析結果を提示
```

---

## 実行例

### 実際のプロンプト例

```markdown
以下の仕様変更を実施してください。

## 変更要求

ダウンロード進捗ダイアログに、残り時間のリアルタイム更新機能を追加したい。

【詳細】
- 現在：ダウンロード開始時の予測時間が固定値で表示される
- 変更後：car完了ごとに実測時間から残り時間を再計算して表示
- 追加機能：1carのダウンロードに1分以上かかる場合、1分ごとにカウントダウン
- 設定：各記録種別（DATA_KIND）ごとに1car当たりの予測時間をINIファイルで設定可能

## ソースコードの場所

- メインプロジェクト: D:\Home\MCR\R211\SRC\MDS_PTE\
- 進捗ダイアログ: D:\Home\MCR\R211\SRC\MDS_PTE\dlgDLProgress.cs
- ダウンロード処理: D:\Home\MCR\R211\SRC\MDS_PTE\frmLogDataDownload.cs
- 進捗情報クラス: D:\Home\MCR\R211\SRC\MDS_PTE\ProgressInfo.cs
- 設定ファイル（開発版）: D:\Home\MCR\R211\SRC\MDS_PTE\MDS_PTE.ini
- 設定ファイル（パッケージ版）: D:\Home\MCR\R211\SRC\SetupPkg\MDS_PTE.ini

## 出力ファイルの保存場所

- 分析結果: D:\Home\MCR\R211\Output\Analysis\
- 変更仕様書: D:\Home\MCR\R211\Output\Specs\
- テスト仕様書: D:\Home\MCR\R211\Output\Tests\

## 実施手順

以下の手順で作業を進めてください。各承認ポイントで必ず私の承認を得てから次に進んでください。

### 1. 事前準備
- TodoListを作成し、全体の作業項目を管理
- 各タスクの完了時にTodoを更新

### 2. 影響範囲分析（spec-analyzer使用）
- spec-analyzerエージェントを起動
- コードベース全体への影響を分析
- 以下のファイルを生成：
  - analysis-result.json
  - analysis-summary.md
- **【承認ポイント1】** 分析結果を提示し、承認を待つ

### 3. 実装計画の作成
- 分析結果に基づいて詳細な実装計画を作成
- 優先順位、リスク、工数見積もりを含める
- **【承認ポイント2】** 実装計画を提示し、承認を待つ

### 4. 変更仕様書とフローチャート生成（spec-doc-generator使用）
- spec-doc-generatorエージェントを起動
- 分析結果（analysis-result.json）を参照
- SPEC_CHANGES.html と flowchart_No001.drawio を生成
- **【承認ポイント3】** 変更仕様書とフローチャートを提示し、承認を待つ

### 5. ソースコード変更の実装
- 承認された仕様書に基づいて実装
- 優先度の高い項目から順に実装
- 後方互換性、エラーハンドリング、リソース管理に注意

### 6. テスト仕様書の作成
- 単体テスト、統合テスト、実機テストのテストケースを作成
- **【承認ポイント4】** テスト仕様書を提示し、承認を待つ

### 7. 完了報告
- 全ての成果物を確認
- 変更内容のサマリーを報告

## 注意事項

- 各承認ポイントで必ず作業を止め、私の指示を待ってください
- 不明点や懸念事項があれば、すぐに質問してください

それでは、作業を開始してください。
```

---

## Tips

### より詳細な指示を追加したい場合

```markdown
## 追加要件

### コーディング規約
- 変数名はキャメルケース
- クラス名はパスカルケース
- コメントは日本語で記述

### パフォーマンス要件
- UI更新は1秒に1回以下
- メモリリークがないこと

### セキュリティ要件
- INIファイルの値は必ず検証
- 数値オーバーフローに注意
```

### 特定のファイルのみ変更したい場合

```markdown
## 変更範囲の制限

以下のファイルのみ変更してください：
- dlgDLProgress.cs
- ProgressInfo.cs

以下のファイルは変更しないでください：
- frmLogDataDownload.cs（影響を最小限にするため）
```

---

## トラブルシューティング

### 承認ポイントで止まらない場合

以下のように明示的に指示：

```markdown
**重要**: 各承認ポイントで必ず作業を停止し、「承認待ち」と表示してください。
私が「承認します」または「次へ進んでください」と返答するまで、次のステップに進まないでください。
```

### TodoListが更新されない場合

```markdown
**TodoList管理について**:
- 作業開始時に全タスクをTodoListに追加
- 各タスク開始時に in_progress に更新
- 各タスク完了時に completed に更新
- 私に進捗状況を常に表示
```

---

## まとめ

このワークフローガイドを使用することで：
- ✅ 体系的な仕様変更プロセス
- ✅ 各段階での確認・承認
- ✅ TodoListによる進捗管理
- ✅ 品質の高い成果物（分析、仕様書、実装、テスト）

が実現できます。
